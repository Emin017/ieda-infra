name: Create Release
on:
  pull_request:
    types: [closed]
    branches:
      - main
jobs:
  release-approval:
    if: ${{ github.event.pull_request.merged == true && contains(github.event.pull_request.title, 'iedaUnstable') }}
    runs-on: ubuntu-latest
    environment:
      name: ieda-release
      url: https://github.com/${{ github.repository }}/releases
    steps:
      - name: Await release approval
        run: echo "Manual approval granted. Proceeding with release."

  create-release:
    # Only run if PR was merged and title contains "iedaUnstable"
    if: ${{ github.event.pull_request.merged == true && contains(github.event.pull_request.title, 'iedaUnstable') }}
    needs: release-approval
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6
        with:
          ref: main  # Checkout the merged commit on main branch
      - uses: DeterminateSystems/nix-installer-action@main
      - name: Extract version from PR title
        id: extract-version
        run: |
          # PR title format: "iedaUnstable: 0.1.0-unstable-2024-01-01 -> 0.1.0-unstable-2024-01-02"
          PR_TITLE="${{ github.event.pull_request.title }}"
          echo "PR Title: $PR_TITLE"
          
          # Extract old and new versions
          OLD_VERSION=$(echo "$PR_TITLE" | sed -n 's/.*iedaUnstable: \(.*\) -> .*/\1/p')
          NEW_VERSION=$(echo "$PR_TITLE" | sed -n 's/.*-> \(.*\)/\1/p')
          
          echo "OLD_VERSION=$OLD_VERSION"
          echo "NEW_VERSION=$NEW_VERSION"
          
          echo "old_version=$OLD_VERSION" >> $GITHUB_OUTPUT
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
      - name: Build iEDA ARX Bundle
        run: nix bundle -L '.#iedaUnstable'
      - name: Build iEDA RPM Bundle
        run: nix bundle -L --bundler github:NixOS/bundlers#toRPM '.#iedaUnstable'
      - name: Build iEDA DEB Bundle
        run: nix bundle -L --bundler github:NixOS/bundlers#toDEB '.#iedaUnstable'
      - name: Build iEDA Release Docker
        run: nix build -L '.#releaseDocker'
      - name: Create Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Creating a new release..."
          NEW_VERSION="${{ steps.extract-version.outputs.new_version }}"
          OLD_VERSION="${{ steps.extract-version.outputs.old_version }}"
          RELEASE_TAG="$NEW_VERSION"
          RELEASE_NAME="iEDA $NEW_VERSION"

          # Verify versions
          echo "OLD_VERSION: $OLD_VERSION"
          echo "NEW_VERSION: $NEW_VERSION"

          # Create the release notes file
          {
            echo "## iEDA $NEW_VERSION"
            echo ""
            echo "This is an automated release for iEDA unstable version."
            echo ""
            echo "### Changes"
            echo "- Updated iEDA source from $OLD_VERSION to $NEW_VERSION"
            echo ""
            echo "### Artifacts"
            echo "- \`ieda-arx\`: ARX offline bundle"
            echo "- \`rpm-single-ieda/*.rpm\`: RPM bundle files (e.g. ieda-0.1.0_unstable-<rev>.rpm)"
            echo "- \`deb-single-ieda/*.deb\`: DEB bundle files (e.g. ieda_0.1.0-unstable-<rev>.deb)"
            echo ""
            echo "### Installation"
            echo "\`\`\`bash"
            echo "# Using Nix"
            echo "nix run github:Emin017/ieda-infra#iedaUnstable"
            echo ""
            echo "# Using RPM bundle"
            echo "sudo rpm -i rpm-single-ieda/*.rpm"
            echo ""
            echo "# Using DEB bundle"
            echo "sudo dpkg -i deb-single-ieda/*.deb"
            echo "\`\`\`"
            echo ""
            echo "### Related PR"
            echo "- #${{ github.event.pull_request.number }}"
            echo ""
            echo "---"
            echo "*This release was automatically generated by GitHub Actions.*"
          } > release_notes.md

          # Create the release on the main branch
          nix run nixpkgs#gh -- release create "$RELEASE_TAG" \
            --title "$RELEASE_NAME" \
            --notes-file release_notes.md \
            --target main \
            --repo "${{ github.repository }}"

          echo "Release $RELEASE_TAG created successfully!"

          upload_artifacts() {
            local dir="$1"
            local tag="$2"
            local repo="$3"
            local label="$4"
            echo "Uploading $label..."
            if [ -d "$dir" ]; then
              shopt -s nullglob
              for file in "$dir"/*; do
                if [ -f "$file" ]; then
                  echo "Uploading $(basename "$file")..."
                  nix run nixpkgs#gh -- release upload "$tag" "$file" --clobber --repo "$repo"
                fi
              done
              shopt -u nullglob
            else
              echo "Directory $dir not found; skipping."
            fi
          }

          upload_file() {
            local file="$1"
            local tag="$2"
            local repo="$3"
            local label="$4"
            echo "Uploading $label..."
            if [ -e "$file" ]; then
              echo "Uploading $(basename "$file")..."
              nix run nixpkgs#gh -- release upload "$tag" "$file" --clobber --repo "$repo"
            else
              echo "File $file not found; skipping."
            fi
          }

          upload_file "./ieda-arx" "$RELEASE_TAG" "${{ github.repository }}" "iEDA ARX Bundle"
          upload_artifacts "./rpm-single-ieda" "$RELEASE_TAG" "${{ github.repository }}" "iEDA RPM Bundle"
          upload_artifacts "./deb-single-ieda" "$RELEASE_TAG" "${{ github.repository }}" "iEDA DEB Bundle"

          echo "Release artifacts uploaded successfully!"
